<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="ThemeBucket">
  <link rel="shortcut icon" href="#" type="image/png">
  <title>Dynamic Table</title>
 <link href="assets/bootstrap/css/bootstrap.min.css" rel="stylesheet">

   <!--dynamic table-->
  <link href="js/advanced-datatable/css/demo_page.css" rel="stylesheet" />
  <link href="js/advanced-datatable/css/demo_table.css" rel="stylesheet" />
  <link rel="stylesheet" href="js/data-tables/DT_bootstrap.css" />
  <link href="css/layer.css" rel="stylesheet">
  <link href="css/style.css" rel="stylesheet">
  <link href="css/style-responsive.css" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="css/bootstrap-fileupload.min.css" />
 <link rel="stylesheet" href="css/bootstrap-table.css" />
 <!-- 	
 HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
  <script src="js/html5shiv.js"></script>
  <script src="js/respond.min.js"></script>
  <![endif]-->
      <link href="css/style-responsive.css" rel="stylesheet">
 <style type="text/css">
    	.inp{
    		height: 40px;
    		width:250px;
    	}
    	#selectClass{
    		width:250px;
    		height:30px;
    	}
    	#wrap{
    		margin-left: 60px;
    	}
    	.bkcolor{
    	 	background:#f0fbeb

    	 }
    	 .bkcolor1{
    	 	
			border:1px solid #bbe1f1;background:#eefaff
    	 }
    </style>
</head>

<body class="sticky-header">

<section>
    <!-- left side start-->
    <div class="left-side sticky-left-side">

        <!--logo and iconic logo start-->
        <div class="logo">
            <a href="dynamic_table2.html"><img src="images/university/zuoLogo.png" style="width:150px;" alt=""></a>
        </div>

        <div class="logo-icon text-center">
            <a href="index.html"><img src="images/logo_icon.png" alt=""></a>
        </div>
        <!--logo and iconic logo end-->


        <div class="left-side-inner">

            <!-- visible to small devices only -->
            <div class="visible-xs hidden-sm hidden-md hidden-lg">
                <div class="media logged-user">
                    <img alt="" src="images/photos/user-avatar.png" class="media-object">
                    <div class="media-body">
                        <h4><a href="#">John Doe</a></h4>
                        <span>"Hello There..."</span>
                    </div>
                </div>

                <h5 class="left-nav-title">Account Information</h5>
                <ul class="nav nav-pills nav-stacked custom-nav">
                    <li><a href="#"><i class="fa fa-user"></i> <span>Profile</span></a></li>
                    <li><a href="#"><i class="fa fa-cog"></i> <span>Settings</span></a></li>
                    <li><a href="#"><i class="fa fa-sign-out"></i> <span>Sign Out</span></a></li>
                </ul>
            </div>

            <!--sidebar nav start-->
            <ul class="nav nav-pills nav-stacked custom-nav">
               
               
               	<li id="login"><a href="login.html"><i class="fa fa-sign-in"></i> <span>登录</span></a></li>
               	<li id="teacher"><a href="student_list.html"><i class="fa fa-laptop"></i> <span>教师管理</span></a></li>
               	<li id="Yz"><a href="dynamic_table2.html"><i class="fa fa-laptop"></i> <span>调剂人数</span></a></li>
            </ul>
            <!--sidebar nav end-->

        </div>
    </div>
    <!-- left side end-->
    
    <!-- main content start-->
    <div class="main-content" >

        <!-- header section start-->
        <div class="header-section">

        <!--toggle button start-->
        <a class="toggle-btn"><i class="fa fa-bars"></i></a>
        <!--toggle button end-->

        <!--search start-->
        <form class="searchform" action="index.html" method="post">
            <input type="text" class="form-control" name="keyword" placeholder="Search here..." />
        </form>
        <!--search end-->

        <!--notification menu start -->
        <div class="menu-right">
            <ul class="notification-menu">
                
                <li>
                    <a href="login.html" id="loginOK" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                        <img id="stuImg" src="" alt="" />
                        <span id="sname2" title=""></span>  
                                   
                    </a>
                    <a href="login.html" id="loginNone" class="btn btn-default dropdown-toggle">
                        	登录/注册                   
                    </a>
                    <ul class="dropdown-menu dropdown-menu-usermenu pull-right">
                       <!--  <li><a href="#"><i class="fa fa-user"></i>  Profile</a></li>
                        <li><a href="#"><i class="fa fa-cog"></i>  Settings</a></li> -->
                        <li><a href="login.html" id="logout"><i class="fa fa-sign-out"></i> Log Out</a></li>
                    </ul>
                </li>

            </ul>
        </div>
        <!--notification menu end -->

        </div>
        <!-- header section end-->

        
        <!-- page heading end-->

        <!--body wrapper start-->
        <div class="wrapper">
        <div class="row">
        <div class="col-sm-12">
        <section class="panel">
        <header class="panel-heading bkcolor1">
          <span style="font-size:25px;margin-left:44%;font-weight:bold;font-family:'楷体';"> 调剂人数</span>    
           
        </header>
        <div class="panel-body bkcolor1">
		 		
							<!---->
        <table id="table1" class="bkcolor1">      
        </table>
       
        </div>
        </section>
		<!---->
		<section class="panel bkcolor" style="border:1px solid #96c2f1;">
        
        <div class="panel-body">
           <div class="table-box" style="margin: 20px;" id="searchForm1">
				<div id="toolbar">
					<button id="allUpdate" class="btn btn-default">一键修改</button>
					<button id="okUpdate" class="btn btn-default">确认修改</button>
				
					<!--  <a href="javascript:;" class="btn btn-primary" id="addColumn">addClumn</a> -->
					原始：<span id="numm"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
					修改后：<span id="numm2"></span>
				</div>				
			</div>
		 		
							<!---->
        <section class="panel bkcolor">
        <header class="panel-heading">
           <span style="font-size:25px;margin-left:44%;font-weight:bold;font-family:'楷体';">专业注册</span>    
        </header>
        <div class="panel-body bkcolor">
             <form class="form-signin bkcolor" style="margin-top:10px;" id="stuForms" method="post" enctype="multipart/form-data">
		        <div class="login-wrap" style="margin-top:10px;">
		            <p>请填写专业信息</p>
		            <input id="pname" onblur="pnamefunction()" name="pname" type="text" autofocus="" placeholder="专业名" class="inp">
		            <span id="pnameshow"></span><br>
		            
		            <input id="pdetail" type="text" name="pdetail" onblur="pdetailfunction()" placeholder="专业详细描述" class="inp">
		            <span id="pdetailshow"></span><br>
		            
		            <input id="ptest" type="text" name="ptest" placeholder="专业备注(选填)" class="inp">
		            
		            <div class="fileupload fileupload-new" data-provides="fileupload">
		            
		              <div class="fileupload-new thumbnail" style="width: 200px; height: 150px;">
		                  <img src="http://www.placehold.it/200x150/EFEFEF/AAAAAA&amp;text=no+image" alt="" />
		              </div>
		              <div class="fileupload-preview fileupload-exists thumbnail" style="max-width: 200px; max-height: 150px; line-height: 20px;"></div>
		              <div>
		               <span class="btn btn-default btn-file" type="hidden">
		                <span class="fileupload-new"><i class="fa fa-undo"></i>Change plogo</span>
		               <span class="fileupload-exists"><i class="fa fa-undo"></i>Change plogo</span>
		               <input type="file" name="file1" class="default" />                                                   
		               </span>
		              </div>
		            </div>
		
		            <!-- 同步提交，设为submit，form表单中添加属性enctype="multipart/form-data"，脚本这边就完事了 -->
		            <span id="regshow"></span>
		            													<!-- submit -->
		            <button id="registration" onclick="sub()" type="reset" class="btn btn-lg btn-login btn-block">
		                <i class="fa fa-check"></i>
		            </button>
		        </div>
		
		    </form> 
        </div>       
        </section>
     
        </div>
        </section>
        </div>
        </div>
       
        </div>
        <!--body wrapper end-->

        <!--footer section start-->
        <footer>
            2014 &copy; AdminEx by ThemeBucket
        </footer>
        <!--footer section end-->


    </div>
    <!-- main content end-->
</section>

<!-- Placed js at the end of the document so the pages load faster -->
<script src="js/jquery-1.10.2.min.js"></script>
<script src="js/jquery-ui-1.9.2.custom.min.js"></script>
<script src="js/jquery-migrate-1.2.1.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/modernizr.min.js"></script>
<script src="js/jquery.nicescroll.js"></script>
<!--dynamic table-->
<script src="js/bootstrap-table.js"></script>  
<script src="js/bootstrap-table-export.js"></script>
<script src="js/bootstrap-table-zh-CN.js"></script>
<script src="js/tableExport.js"></script>
	<script src="js/layer.js"></script>
<script type="text/javascript" language="javascript"
 src="js/advanced-datatable/js/jquery.dataTables.js"></script>
<script type="text/javascript" src="js/data-tables/DT_bootstrap.js"></script>
<!--dynamic table initialization -->
<script src="js/dynamic_table_init.js"></script>
<script type="text/javascript" src="js/bootstrap-fileupload.min.js"></script>
<!--common scripts for all pages-->
<script src="js/scripts.js"></script>
<script>
var usernifo= null;
	$(document).ready(function(){	
		//解析缓存login
		
		//HTML5和大多数浏览器兼容性问题了。
		if(window.localStorage){
			//读取HTML5中的缓存，key是deptlist，而且读取出来text格式，还需要JSON.p.. text转换为json格式
			usernifo=JSON.parse(localStorage.getItem("teainfo"));
		}else{
			usernifo=Cookie.read("teainfo");
		}
		if(usernifo!=null && usernifo!=""){
		    $("#sname2").html(usernifo.teaname);
		    $("#sname2").attr("title",usernifo.teaid);
		    //alert(usernifo.slogo);
		    $("#stuImg").attr("src","upload/"+usernifo.tealogo);
		    $("#loginOK").css('display','block');
		    $("#loginNone").css('display','none');
		  	
		    //getScid();
		}else{
			$("#loginNone").css('display','block');
		    $("#loginOK").css('display','none');
		    //dataTable();
		}
		$("#allUpdate").click(function(){

			if(usernifo==null||usernifo==""){
						if(confirm("请先登录，再进行操作")){
							location.href="login.html";	
						}
						return;
					}
			$.ajax({
				url:'updateAllYzTable',
				method:'post',
				dataType:'json',
				success:function(data){
					layer.msg("请手动修改不足之处，在点击确认修改按钮");
					$("#table1").bootstrapTable('load',data);
				},
				error:function(){
					alert("error")
					
				}
			});	
		});
		//okUpdate numm numm2
		$("#okUpdate").click(function(){

			if(usernifo==null||usernifo==""){
						if(confirm("请先登录，再进行操作")){
							location.href="login.html";	
						}
						return;
					}
			var numm=$("#numm").html();
			var numm2=$("#numm2").html();
			if(numm==numm2){
				var ids="";
				var changces="";
				//alert("ok");
				//获取整个table的所有值,变成json对象
				var deptlist=JSON.stringify($("#table1").bootstrapTable('getData'));
				//如果遍历的时候还需要JSON.parse 转化
				deptlist=JSON.parse(deptlist);
				$.each(deptlist,function(i){
				    $.each(deptlist[i],function(k,v){					
					   //比对和遍历只是两列,只是手动修改值的那一列
					   if("infoid"==k){
						   ids+=(parseInt(v)+";");
					   }
					   if("cnumChange"==k){
						   changces+=(parseInt(v)+";");
					   }
					})
				});
				var data={
						"ids":ids,
						"changces":changces
				}
				$.ajax({
					url:'updateYzTable',
					method:'post',
					data:data,
					dataType:'text',
					success:function(data){
						if(data.indexOf("ok")!=-1){
							layer.msg("修改成功");
						}else{
							layer.msg("修改失败");
						}
						
					},
					error:function(){
						alert("error")
						
					}
				});
			}else{
				layer.msg("前后修改不一致，请重新编辑");
			}
		});
		$("#layout2").hide();		
		$("#table1").bootstrapTable({
	        //contentType: "application/x-www-form-urlencoded",//必须要有！！！！
			url: 'selectCompsAllForT2',
			method : 'get', //
			toolbar: '#searchForm1',//searchForm1        
			pagination : true, //是否显示分页（*）
			//queryParams : queryParams,
	         pageSize : 5, //初始化页大小
				pageList : [ 3, 5, 10 ],//data-page-list="[4, 7, 15]"
				singleSelect : false,
				sortable : true, //是否启用排序 				
				sidePagination : "client", //分页方式：client客户端分页，server服务端分页（*）
				strictSearch : true,
				minimumCountColumns : 2, //最少允许的列数
				clickToSelect : true, //是否启用点击选中行
				showRefresh : false, //是否显示刷新按钮
				uniqueId : "uid", //每一行的唯一标识，一般为主键列
				//cardView : true, //是否显示详细视图
				search : true,
				strictSearch : true,
				showColumns : true,
				showRefresh : true,
				showExport:true,
			onLoadError : function(data) {
				$('#table1').bootstrapTable('removeAll');
			},	
			//
			columns : [{
				field : 'infoid',
				title : '公司ID1',
				align : 'center',
	            sortable : true
			}, {
				field : 'uname',
				title : '公司Name',
				align : 'center',
	            sortable : true
			},{
				field : 'basicNum',
				title : '原先人数',
				align : 'center',
	            sortable : true
			},{
				field : 'iattendance',
				title : '修改后的人数',
				align : 'center',
	            sortable : true
			},{
				field : 'cnumChange',
				title : '原人数基础上',
				align : 'center',
	            sortable : true
			}/* ,{
		        title: '操作',
		        field: 'un',
		        align: 'center',
		        formatter:function(value,row,index){						
		        //把之前的列表链接 一行记录json {“uid”:2,"uname":....}	就是参数 row
		        	var d ="<a href='javascript:void(0);' media='"+row.c_pros+
		        	"' title='"+row.cid+"' id='delequ' class='btn btn-success' >Detail</a>";
		        	//row.uid得bootstrap当前table的一行找到   
		        	return d;
		        }
		    } */],
			onDblClickCell: function(field, value, row, $element) {

				if(usernifo==null||usernifo==""){
							if(confirm("请先登录，再进行操作")){
								location.href="login.html";	
							}
							return;
						}
				var beforechangce=row.iattendance;
				var afterchangce=row.iattendance;
				var rightcell=row.cnumChange;
				//错误的逻辑: 第一次双击的时候计算和显示所有没调剂之前的人数总和
				if(firstNum==0){
				   saveNumber();
				}
				//只能接受一列可以手动修改数字
				if(field=="iattendance"){
					
					//改变可以修改的状态脚本
					$element.attr('contenteditable', true);//编辑状态了
					//鼠标焦点离开的时候,之前编辑的单元格又不是编辑状态了,触发事件
					$element.blur(function() {
						//获取编辑的类的id和 value
						let index = $element.parent().data('index');
						let tdValue = $element.html();
						//修改bootstrapTable显示的内容
						afterchangce=tdValue;
						var changce=rightcell+(afterchangce-beforechangce);
						saveData(index, field, tdValue,changce);
						getTableData();
					})
				}else{
					//点击其他不能让院长手动编辑的单元格,不能编辑状态
				   alert(value+" - "+row.uname);	
				}	
			}
	   });
	   $("#insertButton").click(function() {
        //$("#table1").bootstrapTable('insertRow', {
          //  index: 0,
           // row: {
              //  id: '',
              //  name: '',
              //  price: ''
           // }
        //});
    });
	
	var firstNum=0;		
	function saveNumber(){
		var deptlist=JSON.stringify($("#table1").bootstrapTable('getData'));
		//alert(deptlist);
		deptlist=JSON.parse(deptlist);
		$.each(deptlist,function(i){
		    $.each(deptlist[i],function(k,v){	
			   if("iattendance"==k){
				   firstNum+=parseInt(v);
			   }
			})
		})
		//$("#numm").html("原始:"+firstNum);
		$("#numm").html(firstNum);
		$("#numm2").html(firstNum);
	}
	   //$('#getTableData').click(function() {
		function getTableData(){
		    var second=0;
			//获取整个table的所有值,变成json对象
			var deptlist=JSON.stringify($("#table1").bootstrapTable('getData'));
			//如果遍历的时候还需要JSON.parse 转化
			deptlist=JSON.parse(deptlist);
			$.each(deptlist,function(i){
			    $.each(deptlist[i],function(k,v){					
				   //比对和遍历只是两列,只是手动修改值的那一列
				   if("iattendance"==k){
					   second+=parseInt(v);
				   }
				})
			})
			//$("#numm").html("原始:"+firstNum+",修改后:"+second);
			$("#numm").html(firstNum);
			$("#numm2").html(second);
		}
	  // });
	   //
	   function saveData(index, field, value,changce) {
		  // alert(changce);
			$("#table1").bootstrapTable('updateCell', {
				index: index,       //行索引
				field: field,       //列名
				value: value        //cell值
			});
			$("#table1").bootstrapTable('updateCell', {
				index: index,       //行索引
				field: 'cnumChange',       //列名
				value: changce        //cell值
			})
		}
	   
	   $("#logout").bind("click",function(){
			if (window.localStorage) {
				window.localStorage.removeItem("teainfo");	
			}
		});
	  
	});
	
	var namebool=0;
	//用户名检测
	function pnamefunction(){
		$.ajax({
			url:"ProjectsRegistrationChecked",
			method:"post",
			dataType:"json",
			data:{"pname":$("#pname").val()},
			success:function(data){
				//data为空值,说明pname数据库没找到封装了null,可以注册
				if(data==null || data==""){
					namebool=1;
					$("#pnameshow").html("<img src='upload1/checkok.png' title='该专业名可以使用'/>");				
				}else{
					namebool=0;
					//之前判断过data不为空,不用担心空指针
					//data.pname为空,说明返回的是空对象,也就是pname为空(servlet中pname为空给实例化空对象),显示提示信息
					if(data.pname==null||data.pname==""){	
						$("#pnameshow").html("<img src='upload1/checknone.png' title='专业名不能为空'/>");						
					//其他情况,也就是返回的为内部有值的对象,不能注册
					}else{
						$("#pnameshow").html("<img src='upload1/checknone.png' title='该专业名已被注册'/>");
					}
				}			
			},
			error:function(){
			   	alert("eerr1");
			}
		});
	}
	var pdetailbool=0;
	function pdetailfunction(){
		var pdetail=$("#pdetail").val()
		if(pdetail==null || pdetail==""){
			pdetailbool=0;
			$("#pdetailshow").html("<img src='upload1/checknone.png' title='专业详情不能为空'/>");
							
		}else{
			pdetailbool=1;
			$("#pdetailshow").html("<img src='upload1/checkok.png' title='ok'/>");
		}		
	}
	function sub(){
		if(usernifo==null||usernifo==""){
			if(confirm("请先登录，再进行操作")){
				location.href="login.html";	
			}
			return;
		}
		if(namebool==1&&pdetailbool==1){
			$("#regshow").html("");
			var foData=new FormData($("#stuForms")[0]);
			$.ajax({
				url: "proRegistration",    //批量固定路径上传
			    type: 'POST',  
			    data: foData, 
		        cache: false,  
		        contentType: false,
		        processData: false,  
			    dataType: "text",   //返回的异步数据格式为不能json，必须是文本格式
			    success:function(data){
			    	if(data.indexOf("ok")!=-1){
			    		layer.msg("新增专业成功");
			    	}else{
			    		layer.msg("新增专业失败");
			    	}
			    	
				},
			    error:function(){
			    	alert("eerr9");
			    }
			});
		}else{				
			$("#regshow").html("请先正确填写注册信息");
			$("#regshow").css("color","red");
		}
	}
</script>
</body>
</html>
